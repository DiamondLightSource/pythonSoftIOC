##########################################################################
# Copyright (c) 2003 The University of Chicago, as Operator of Argonne
#     National Laboratory.
# Copyright (c) 2003 The Regents of the University of California, as
#     Operator of Los Alamos National Laboratory.
# EPICS BASE Versions 3.13.7 and higher are distributed subject to the
# Software License Agreement found in the file LICENSE that is included
# with this distribution.
##########################################################################

TOP=..

include $(TOP)/configure/CONFIG


# Discover the correct name for the python library and its location.  This is
# surprisingly tricky, as we want to support quite a number of different
# configurations of Python interpreter.
PYTHON_LIB := $(shell $(PYTHON) -c \
    'from __future__ import print_function; \
    from distutils import sysconfig; \
    print(sysconfig.get_config_var("LIBRARY")[3:-2])')
PYTHON_LIB_DIR := $(shell $(PYTHON) -c \
    'from __future__ import print_function; \
    from distutils import sysconfig; \
    print(sysconfig.get_config_var("LIBDIR"))')


USR_CFLAGS += -std=gnu99 -Werror

# We just want the include path for the python library, that should be enough.
# There are a lot of other settings which may conflict with EPICS build
# settings, so we omit them.
USR_CFLAGS += $(shell $(PYTHON_CONFIG) --cflags | tr ' '  '\n' | grep '^-I')

# This tells the compiler to ignore errors generated by EPICS includes.  We need
# this because the EPICS headers have non strict prototypes in places.
USR_CPPFLAGS += -isystem $(EPICS_BASE)/include


PROD_IOC_DEFAULT = softIoc
PROD_IOC_vxWorks = -nil-

DBD += softIoc.dbd
softIoc_DBD += base.dbd

USR_CFLAGS += -DEPICS_BASE='"$(shell cd "$(EPICS_BASE)" && pwd)"'

softIoc_SRCS += softIoc_registerRecordDeviceDriver.cpp
softIoc_SRCS += softMain.c

softIoc_LIBS += $(EPICS_BASE_IOC_LIBS)
softIoc_LIBS += PythonSupport
softIoc_LIBS += $(PYTHON_LIB)

softIoc_LDFLAGS += $(shell $(PYTHON_CONFIG) --ldflags)
# For some reason python-config --ldflags doesn't actually tell us where to find
# the python library if we need telling, so this has to be computed here.
$(PYTHON_LIB)_DIR = $(PYTHON_LIB_DIR)

# Support for devIocStats
ifdef DEVIOCSTATS
softIoc_DBD += devIocStats.dbd
softIoc_LIBS += devIocStats
DB += $(DEVIOCSTATS)/db/ioc.db
endif


# ----------------------------------------------------------------------
# Support library for python component, dynamically loaded to assist with
# access to record fields.


LIBRARY_IOC += PythonSupport

# The following are compiled and added to the support library
PythonSupport_SRCS += PythonSupport.c

PythonSupport_LIBS += $(EPICS_BASE_IOC_LIBS)


# include $(TOP)/configure/RULES_TOP
include $(TOP)/configure/RULES
